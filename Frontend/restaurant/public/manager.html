<!DOCTYPE html>
<html>
<head>
    <title>Restaurant Menu Control Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0505 50%, #0a0a0a 100%);
            background-attachment: fixed;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .logo-header { display: flex; align-items: center; gap: 20px; }
        .logo-icon { font-size: 80px; }
        h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, #ff0000, #8B0000, #ff4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }
        .user-info-panel {
            background: rgba(42, 42, 42, 0.8);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid rgba(139, 0, 0, 0.3);
            min-width: 200px;
            text-align: center;
        }
        .user-info-panel h3 { color: #ff4444; margin-bottom: 10px; }
        .user-info-panel p { color: #b0b0b0; margin: 5px 0; }
        .logout-btn {
            background: linear-gradient(135deg, #c41e1e, #ff4444);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            width: 100%;
        }
        .nav-tabs { display: flex; gap: 40px; justify-content: center; margin-bottom: 40px; border-bottom: 2px solid rgba(139, 0, 0, 0.3); padding-bottom: 15px; }
        .nav-tab { color: #888; font-size: 1.3em; font-weight: bold; cursor: pointer; position: relative; }
        .nav-tab.active { color: #ff4444; }
        .nav-tab.active::after { content: ''; position: absolute; bottom: -17px; left: 0; width: 100%; height: 3px; background: linear-gradient(90deg, #ff0000, #8B0000); }
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: rgba(42, 42, 42, 0.8); padding: 30px; border-radius: 15px; border: 2px solid rgba(139, 0, 0, 0.3); text-align: center; }
        .stat-value { color: #ff4444; font-size: 2.5em; font-weight: bold; }
        .stat-label { color: #e0e0e0; font-size: 1.5em; font-weight: bold; margin-top: 10px; }
        .section-title { color: #ff4444; font-size: 1.8em; margin: 40px 0 20px 0; padding-left: 20px; }
        .transactions-table { background: rgba(42, 42, 42, 0.8); border-radius: 15px; border: 2px solid rgba(139, 0, 0, 0.3); }
        .table-header, .table-row { display: grid; grid-template-columns: 1fr 1fr 1fr; padding: 20px; }
        .table-header { background: rgba(26, 26, 26, 0.9); color: #888; font-weight: bold; }
        .table-row { border-top: 1px solid rgba(139, 0, 0, 0.2); }
        .order-filters { display: flex; gap: 20px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap; }
        .filter-btn { background: rgba(42, 42, 42, 0.8); color: #888; padding: 12px 30px; border: 2px solid rgba(139, 0, 0, 0.3); border-radius: 50px; cursor: pointer; font-weight: bold; }
        .filter-btn.active { background: linear-gradient(135deg, #8B0000, #c41e1e); color: white; }
        .orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .order-card { background: rgba(42, 42, 42, 0.8); padding: 20px; border-radius: 15px; border: 2px solid rgba(139, 0, 0, 0.3); }
        .order-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .order-id { color: #e0e0e0; font-size: 1.1em; font-weight: bold; }
        .order-status { color: #ff4444; font-weight: bold; }
        .order-items { color: #b0b0b0; margin-bottom: 15px; line-height: 1.8; }
        .order-total { color: #ff4444; font-size: 1.3em; font-weight: bold; text-align: right; }
        .menu-form-container { background: rgba(42, 42, 42, 0.8); padding: 30px; border-radius: 15px; border: 2px solid rgba(139, 0, 0, 0.3); margin-bottom: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .image-upload-area { display: flex; align-items: center; justify-content: center; background: rgba(26, 26, 26, 0.8); border: 2px dashed rgba(139, 0, 0, 0.5); border-radius: 15px; min-height: 400px; cursor: pointer; }
        .form-fields { display: flex; flex-direction: column; }
        label { color: #ff6b6b; font-weight: bold; margin-bottom: 8px; }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid rgba(139, 0, 0, 0.3); border-radius: 8px; background: rgba(26, 26, 26, 0.8); color: #e0e0e0; }
        .add-btn { background: linear-gradient(135deg, #c41e1e, #ff4444); color: white; padding: 12px 30px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; }
        .menu-card { background: rgba(42, 42, 42, 0.8); border-radius: 15px; border: 2px solid rgba(139, 0, 0, 0.3); overflow: hidden; }
        .menu-image { width: 100%; height: 250px; object-fit: cover; }
        .menu-content { padding: 20px; }
        .menu-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .menu-name { color: #ff4444; font-size: 1.3em; font-weight: bold; }
        .menu-price { color: #ff4444; font-size: 1.2em; font-weight: bold; }
        .menu-info { color: #b0b0b0; margin-bottom: 8px; }
        .menu-description { color: #e0e0e0; margin: 15px 0; }
        .menu-actions { display: flex; gap: 10px; margin-top: 15px; }
        .action-btn { flex: 1; background: linear-gradient(135deg, #c41e1e, #ff4444); color: white; padding: 10px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; }
        .delete-btn { background: linear-gradient(135deg, #8B0000, #c41e1e); }
        .view-section { display: none; }
        .view-section.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <div class="logo-header">
                <div class="logo-icon">üçú</div>
                <h1>Restaurant Menu<br>Control Panel</h1>
            </div>
            <div class="user-info-panel">
                <h3>üë§ User Info</h3>
                <p><strong>Name:</strong> <span id="user-name">-</span></p>
                <p><strong>Role:</strong> <span id="user-role">-</span></p>
                <button class="logout-btn">üö™ LOGOUT</button>
            </div>
        </div>
        <div class="nav-tabs">
            <div class="nav-tab active" data-view="dashboard">Dashboard</div>
            <div class="nav-tab" data-view="orders">Orders</div>
            <div class="nav-tab" data-view="menu">Menu</div>
        </div>
        <div id="dashboard" class="view-section active">
            <div class="dashboard-stats">
                <div class="stat-card"><h3>Today's Revenue</h3><div class="stat-value">‚Ç±0.00</div></div>
                <div class="stat-card"><h3>Total Orders Today</h3><div class="stat-value">0</div></div>
                <div class="stat-card"><h3>Top Menu Product</h3><div class="stat-label">N/A</div></div>
            </div>
            <h2 class="section-title">Transactions</h2>
            <div class="transactions-table">
                <div class="table-header"><div>Transaction ID</div><div>Order ID</div><div>Amount</div></div>
            </div>
        </div>
        <div id="orders" class="view-section">
            <div class="order-filters">
                <button class="filter-btn">All</button>
                <button class="filter-btn active">Pending</button>
                <button class="filter-btn">Preparing</button>
                <button class="filter-btn">Ready</button>
                <button class="filter-btn">Served</button>
            </div>
            <div class="orders-grid"></div>
        </div>
        <div id="menu" class="view-section">
            <div class="menu-form-container">
                <div class="image-upload-area"><div><div style="font-size:3em;margin-bottom:20px">üì∑</div><div>Click to Upload</div></div></div>
                <div class="form-fields">
                    <label>Food Name *</label><input id="food-name" type="text" placeholder="e.g., Ramen">
                    <label>Price *</label><input id="price" type="number" step="0.01" placeholder="79.00">
                    <label>Stock *</label><input id="stock" type="number" placeholder="50">
                    <label>Category *</label>
                    <select id="category">
                        <option value="">-- select --</option>
                        <option value="main">Main</option>
                        <option value="side">Side</option>
                        <option value="appetizer">Appetizer</option>
                        <option value="dessert">Dessert</option>
                        <option value="beverage">Beverage</option>
                    </select>
                    <label>Description</label><textarea id="description" rows="3"></textarea>
                    <button class="add-btn">Add Item</button>
                </div>
            </div>
            <h2 class="section-title">All Menu Items</h2>
            <div class="menu-grid"></div>
        </div>
    </div>
    <script>
        let API_BASE_URL=null,MANAGER_ID=null,currentView='dashboard',currentOrderFilter='Pending';
        let menuItems=[],orders=[],payments=[],editingMenuItem=null,selectedImageFile=null;
        let refreshInterval=null,lastOrdersState=null;

        function getBaseURL(){return window.BACKEND_URL||'http://localhost:8080'}
        function checkAuth(){
            const u=localStorage.getItem('currentUser');
            if(!u){window.location.href='LoginPage.html';return false}
            const user=JSON.parse(u);
            document.getElementById('user-name').textContent=user.name||user.username;
            document.getElementById('user-role').textContent=user.role;
            if(user.role!=='MANAGER'){alert('Access denied');window.location.href='LoginPage.html';return false}
            MANAGER_ID=user.userId;return true;
        }

        document.addEventListener('DOMContentLoaded',()=>{
            API_BASE_URL=getBaseURL();
            if(!checkAuth())return;
            initNav();initOrderFilters();initMenuForm();initLogout();
            loadDashboardData();loadOrders();loadMenuItems();startAutoRefresh();
        });

        function startAutoRefresh(){refreshInterval=setInterval(async()=>{await checkForOrderUpdates()},5000)}
        function stopAutoRefresh(){if(refreshInterval){clearInterval(refreshInterval);refreshInterval=null}}

        async function checkForOrderUpdates(){
            try{
                const r=await fetch(`${API_BASE_URL}/api/orders`);
                const newOrders=await r.json();
                if(hasOrdersChanged(newOrders)){
                    orders=newOrders;
                    if(currentView==='orders')renderOrders();
                    if(currentView==='dashboard')updateDashboardStats();
                    showNotification('Orders updated','info');
                }
            }catch(e){console.error('Error:',e)}
        }

        function hasOrdersChanged(newOrders){
            if(!lastOrdersState){lastOrdersState=JSON.stringify(newOrders);return false}
            const newState=JSON.stringify(newOrders);
            const changed=lastOrdersState!==newState;
            if(changed)lastOrdersState=newState;
            return changed;
        }

        function initNav(){
            document.querySelectorAll('.nav-tab').forEach(tab=>{
                tab.addEventListener('click',()=>{
                    const view=tab.getAttribute('data-view');
                    switchView(view);
                    document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
                    tab.classList.add('active');
                });
            });
        }

        function switchView(view){
            currentView=view;
            document.querySelectorAll('.view-section').forEach(s=>s.classList.remove('active'));
            document.getElementById(view).classList.add('active');
            if(view==='dashboard')loadDashboardData();
            else if(view==='orders')loadOrders();
            else if(view==='menu')loadMenuItems();
        }

        async function loadDashboardData(){
            try{
                await Promise.all([loadPayments(),loadOrders()]);
                updateDashboardStats();renderTransactions();
            }catch(e){console.error('Error:',e)}
        }

        function updateDashboardStats(){
            const today=new Date().toDateString();
            const todayPayments=payments.filter(p=>new Date(p.createdAt).toDateString()===today&&p.paymentStatus==='Paid');
            const todayRevenue=todayPayments.reduce((sum,p)=>sum+p.amount,0);
            const todayOrders=orders.filter(o=>new Date(o.date).toDateString()===today);
            const itemCounts={};
            todayOrders.forEach(order=>{
                order.items?.forEach(item=>{
                    const name=item.menuItem.name;
                    itemCounts[name]=(itemCounts[name]||0)+item.quantity;
                });
            });
            const topProduct=Object.keys(itemCounts).length>0?Object.keys(itemCounts).reduce((a,b)=>itemCounts[a]>itemCounts[b]?a:b):'N/A';
            document.querySelector('.stat-card:nth-child(1) .stat-value').textContent=`‚Ç±${todayRevenue.toFixed(2)}`;
            document.querySelector('.stat-card:nth-child(2) .stat-value').textContent=todayOrders.length;
            document.querySelector('.stat-card:nth-child(3) .stat-label').innerHTML=topProduct.replace(' ','<br>');
        }

        function renderTransactions(){
            const table=document.querySelector('.transactions-table');
            const header=table.querySelector('.table-header');
            table.innerHTML='';table.appendChild(header);
            [...payments].sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).forEach(p=>{
                const row=document.createElement('div');
                row.className='table-row';
                row.innerHTML=`<div class="table-cell">#${p.paymentId}</div><div class="table-cell">#${p.order.orderId}</div><div class="table-cell">‚Ç±${p.amount.toFixed(2)}</div>`;
                table.appendChild(row);
            });
        }

        function initOrderFilters(){
            document.querySelectorAll('#orders .filter-btn').forEach(btn=>{
                btn.addEventListener('click',()=>{
                    currentOrderFilter=btn.textContent.trim();
                    document.querySelectorAll('#orders .filter-btn').forEach(b=>b.classList.remove('active'));
                    btn.classList.add('active');
                    renderOrders();
                });
            });
        }

        async function loadOrders(){
            try{
                const r=await fetch(`${API_BASE_URL}/api/orders`);
                orders=await r.json();
                renderOrders();
            }catch(e){console.error('Error:',e)}
        }

        function renderOrders(){
            const grid=document.querySelector('.orders-grid');
            grid.innerHTML='';
            const filtered=currentOrderFilter==='All'?orders:orders.filter(o=>o.status===currentOrderFilter);
            if(filtered.length===0){grid.innerHTML='<p style="color:#888;text-align:center;padding:40px">No orders</p>';return}
            filtered.forEach(order=>{
                const card=document.createElement('div');
                card.className='order-card';
                const items=order.items?.map(i=>`${i.menuItem.name} x${i.quantity}`).join('<br>')||'No items';
                card.innerHTML=`<div class="order-header"><div class="order-id">#${order.orderId}</div><div class="order-status">${order.status}</div></div><div class="order-items">${items}</div><div class="order-total">‚Ç±${order.total.toFixed(2)}</div>`;
                grid.appendChild(card);
            });
        }

        function initMenuForm(){
            const area=document.querySelector('.image-upload-area');
            area.addEventListener('click',()=>{
                const input=document.createElement('input');
                input.type='file';input.accept='image/*';
                input.onchange=(e)=>handleImageSelect(e.target.files[0]);
                input.click();
            });
            document.querySelector('.add-btn').addEventListener('click',handleMenuFormSubmit);
        }

        function handleImageSelect(file){
            selectedImageFile=file;
            const reader=new FileReader();
            reader.onload=(e)=>{
                document.querySelector('.image-upload-area').innerHTML=`<img src="${e.target.result}" style="max-width:100%;max-height:100%;object-fit:contain">`;
            };
            reader.readAsDataURL(file);
        }

        async function handleMenuFormSubmit(){
            const name=document.getElementById('food-name').value.trim();
            const price=parseFloat(document.getElementById('price').value);
            const stock=parseInt(document.getElementById('stock').value);
            const category=document.getElementById('category').value;
            const description=document.getElementById('description').value.trim();
            if(!name||!price||!stock||!category||!description){showNotification('Fill all fields','error');return}
            try{
                const menuItem={name,price,stockQuantity:stock,category,description};
                if(editingMenuItem){await updateMenuItem(editingMenuItem.menuItemId,menuItem)}
                else{await createMenuItem(menuItem)}
                showNotification(editingMenuItem?'Updated':'Added','success');
                clearMenuForm();await loadMenuItems();
            }catch(e){console.error('Error:',e);showNotification('Failed','error')}
        }

        async function createMenuItem(menuItem){
            const formData=new FormData();
            if(selectedImageFile){
                formData.append('file',selectedImageFile);
                formData.append('menuItem',JSON.stringify(menuItem));
                const r=await fetch(`${API_BASE_URL}/menu/create/with-image/${MANAGER_ID}`,{method:'POST',body:formData});
                if(!r.ok)throw new Error('Failed');
            }else{
                const r=await fetch(`${API_BASE_URL}/menu/create/${MANAGER_ID}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(menuItem)});
                if(!r.ok)throw new Error('Failed');
            }
        }

        async function updateMenuItem(itemId,menuItem){
            const formData=new FormData();
            if(selectedImageFile)formData.append('file',selectedImageFile);
            formData.append('menuItem',JSON.stringify(menuItem));
            const r=await fetch(`${API_BASE_URL}/menu/update/with-image/${MANAGER_ID}/${itemId}`,{method:'PUT',body:formData});
            if(!r.ok)throw new Error('Failed');
        }

        function clearMenuForm(){
            document.getElementById('food-name').value='';
            document.getElementById('price').value='';
            document.getElementById('stock').value='';
            document.getElementById('category').value='';
            document.getElementById('description').value='';
            selectedImageFile=null;editingMenuItem=null;
            document.querySelector('.image-upload-area').innerHTML='<div><div style="font-size:3em;margin-bottom:20px">üì∑</div><div>Click to Upload</div></div>';
            document.querySelector('.add-btn').textContent='Add Item';
            const cancelBtn=document.querySelector('.cancel-btn');
            if(cancelBtn)cancelBtn.remove();
        }

        async function loadMenuItems(){
            try{
                const r=await fetch(`${API_BASE_URL}/menu`);
                menuItems=await r.json();
                renderMenuItems();
            }catch(e){console.error('Error:',e)}
        }

        function renderMenuItems(){
            const grid=document.querySelector('.menu-grid');
            grid.innerHTML='';
            if(menuItems.length===0){grid.innerHTML='<p style="color:#888;text-align:center;padding:40px">No menu items</p>';return}
            menuItems.forEach(item=>{
                const card=document.createElement('div');
                card.className='menu-card';
                const img=item.imagePath?`${API_BASE_URL}/uploads/${item.imagePath}`:'https://images.unsplash.com/photo-1569718212165-3a8278d5f624?w=800';
                card.innerHTML=`<img class="menu-image" src="${img}" alt="${item.name}"><div class="menu-content"><div class="menu-header"><div class="menu-name">${item.name}</div><div class="menu-price">‚Ç±${item.price.toFixed(2)}</div></div><div class="menu-info"><strong>Category:</strong> ${item.category}</div><div class="menu-info"><strong>Stock:</strong> ${item.stockQuantity}</div><div class="menu-description">${item.description}</div><div class="menu-actions"><button class="action-btn delete-btn" onclick="handleDeleteMenuItem(${item.menuItemId})">Delete</button><button class="action-btn" onclick="handleEditMenuItem(${item.menuItemId})">Edit</button></div></div>`;
                grid.appendChild(card);
            });
        }

        async function handleDeleteMenuItem(itemId){
            if(!confirm('Delete?'))return;
            try{
                const r=await fetch(`${API_BASE_URL}/menu/delete/${MANAGER_ID}/${itemId}`,{method:'DELETE'});
                if(!r.ok)throw new Error('Failed');
                await loadMenuItems();showNotification('Deleted','success');
            }catch(e){showNotification('Failed','error')}
        }

        function handleEditMenuItem(itemId){
            const item=menuItems.find(m=>m.menuItemId===itemId);
            if(!item)return;
            editingMenuItem=item;
            document.getElementById('food-name').value=item.name;
            document.getElementById('price').value=item.price;
            document.getElementById('stock').value=item.stockQuantity;
            document.getElementById('category').value=item.category;
            document.getElementById('description').value=item.description;
            if(item.imagePath){
                document.querySelector('.image-upload-area').innerHTML=`<img src="${API_BASE_URL}/uploads/${item.imagePath}" style="max-width:100%;max-height:100%;object-fit:contain">`;
            }
            document.querySelector('.add-btn').textContent='Save';
            if(!document.querySelector('.cancel-btn')){
                const cancelBtn=document.createElement('button');
                cancelBtn.className='add-btn cancel-btn';
                cancelBtn.textContent='Cancel';
                cancelBtn.style.background='linear-gradient(135deg,#666,#888)';
                cancelBtn.onclick=clearMenuForm;
                document.querySelector('.add-btn').parentNode.appendChild(cancelBtn);
            }
            document.querySelector('.menu-form-container').scrollIntoView({behavior:'smooth'});
        }

        async function loadPayments(){
            try{
                const r=await fetch(`${API_BASE_URL}/api/payments`);
                payments=await r.json();
            }catch(e){console.error('Error:',e)}
        }

        function initLogout(){
            document.querySelector('.logout-btn').addEventListener('click',()=>{
                if(confirm('Logout?')){
                    stopAutoRefresh();
                    localStorage.removeItem('currentUser');
                    window.location.href='LoginPage.html';
                }
            });
        }

        function showNotification(message,type='info'){
            const notification=document.createElement('div');
            notification.style.cssText=`position:fixed;top:20px;right:20px;background:${type==='success'?'#28a745':type==='error'?'#dc3545':'#17a2b8'};color:white;padding:15px 25px;border-radius:8px;box-shadow:0 5px 20px rgba(0,0,0,0.3);z-index:10000;max-width:300px`;
            notification.textContent=message;
            document.body.appendChild(notification);
            setTimeout(()=>notification.remove(),3000);
        }

        window.handleDeleteMenuItem=handleDeleteMenuItem;
        window.handleEditMenuItem=handleEditMenuItem;
    </script>
</body>
</html>